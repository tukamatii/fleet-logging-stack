# Loki Logging Stack –¥–ª—è Kubernetes

- [Loki Logging Stack –¥–ª—è Kubernetes](#loki-logging-stack-–¥–ª—è-kubernetes)
  - [–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞](#–æ–±—â–∞—è-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)
  - [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 1: Promtail Agent](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç-1-promtail-agent)
    - [–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç](#–∑–∞—á–µ–º-–Ω—É–∂–µ–Ω-—ç—Ç–æ—Ç-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç)
    - [–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏)
      - [1. –ü–æ–ª–Ω–æ–¥–∏—Å–∫–æ–≤—ã–π –¥–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∞–º](#1-–ø–æ–ª–Ω–æ–¥–∏—Å–∫–æ–≤—ã–π-–¥–æ—Å—Ç—É–ø-–∫-–ª–æ–≥–∞–º)
      - [2. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –≤ Loki](#2-–±–µ–∑–æ–ø–∞—Å–Ω–∞—è-–ø–µ—Ä–µ–¥–∞—á–∞-–≤-loki)
      - [3. –û–±–æ–≥–∞—â–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏](#3-–æ–±–æ–≥–∞—â–µ–Ω–∏–µ-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏)
  - [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç 2: Grafana Loki](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç-2-grafana-loki)
    - [–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç](#–∑–∞—á–µ–º-–Ω—É–∂–µ–Ω-—ç—Ç–æ—Ç-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç-1)
    - [–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](#–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏-—Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏-1)
      - [1. Multi-–∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ](#1-multi-–∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–µ-—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ)
      - [2. Enterprise-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ](#2-enterprise-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
      - [3. –ú—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ OrgID](#3-–º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å-—á–µ—Ä–µ–∑-orgid)
      - [4. –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å](#4-–æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å)
  - [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-–∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π)
    - [1. –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Cilium Gateway API](#1-–¥–æ—Å—Ç—É–ø-—á–µ—Ä–µ–∑-cilium-gateway-api)
    - [2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#2-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
    - [3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥](#3-–º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥)
  - [–†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ](#—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ-–∏-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ)
    - [GitOps-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è](#gitops-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è)
    - [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è](#—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
  - [Production-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#production-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

## –û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π `fleet-logging-stack` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **–µ–¥–∏–Ω—ã–π —Å—Ç–µ–∫ —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è** –¥–ª—è Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–æ–≤, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ Grafana Loki –∏ Promtail. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ–∞–ª–∏–∑—É–µ—Ç enterprise-grade –ø–æ–¥—Ö–æ–¥ –∫ —Å–±–æ—Ä—É, —Ö—Ä–∞–Ω–µ–Ω–∏—é –∏ –∞–Ω–∞–ª–∏–∑—É –ª–æ–≥–æ–≤:

```mermaid
graph LR
    A[Worker Nodes] -->|DaemonSet| B(Promtail Agents)
    C[Control Plane] -->|DaemonSet| B
    Infra[Infra Nodes] -->|DaemonSet| B
    B -->|Push Logs| D[Loki Gateway]
    D -->|Distribute| E[Loki Write Path]
    E -->|Store| F[(MinIO S3)]
    G[Grafana] -->|Query| D
    H[Auth Proxy] -->|OrgID Mapping| D
    D -->|Read Path| I[Loki Read Path]
    I -->|Query Data| F
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 1: Promtail Agent

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

Promtail ‚Äî —ç—Ç–æ **–∞–≥–µ–Ω—Ç –¥–ª—è —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤** –Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞, —Ä–µ—à–∞—é—â–∏–π –∫–ª—é—á–µ–≤—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

- üìÅ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏ —Å–±–æ—Ä –ª–æ–≥–æ–≤ –≤—Å–µ—Ö –ø–æ–¥–æ–≤
- üîç –û–±–æ–≥–∞—â–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ Kubernetes (namespace, pod, container)
- üöÄ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –ª–æ–≥–æ–≤ –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
- üîÑ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ —á—Ç–µ–Ω–∏—è –ª–æ–≥–æ–≤ –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö —Å TLS –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

**–ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∞–µ—Ç:**

- –ü–æ—Ç–µ—Ä—è –ª–æ–≥–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ/—É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–¥–æ–≤
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –ª–æ–≥–æ–≤ (–∫–∞–∫–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–æ–≥)
- –°–ª–æ–∂–Ω–æ—Å—Ç—å —Å–±–æ—Ä–∞ –ª–æ–≥–æ–≤ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ (kubelet, containerd)
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–∏—Å–∫–∞ –ø–æ –ª–æ–≥–∞–º –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å—Ä–µ–¥–µ

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### 1. –ü–æ–ª–Ω–æ–¥–∏—Å–∫–æ–≤—ã–π –¥–æ—Å—Ç—É–ø –∫ –ª–æ–≥–∞–º

```yaml
volumes:
  - name: logs
    hostPath:
      path: /var/log
volumeMounts:
  - name: logs
    mountPath: /var/log
```

- –°–±–æ—Ä –ª–æ–≥–æ–≤ –∏–∑ `/var/log/pods/*` –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Docker-—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ pipeline stages
- Tolerations –¥–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞ control-plane –∏ infra –Ω–æ–¥–∞—Ö

#### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –≤ Loki

```yaml
clients:
  - url: https://loki.okbtsp.corp/loki/api/v1/push
    bearer_token_file: /etc/promtail/secrets/token
    tls_config:
      ca_file: /etc/promtail/certs/ca.crt
```

- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Bearer-—Ç–æ–∫–µ–Ω –∏–∑ Bitwarden
- –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞—Ñ–∏–∫–∞ —Å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–º CA
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ç–æ–∫–µ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–ª–∞—Å—Ç–µ—Ä–∞

#### 3. –û–±–æ–≥–∞—â–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏

```yaml
relabel_configs:
  - action: labelmap
    regex: __meta_kubernetes_pod_label_(.+)
  - source_labels: [__meta_kubernetes_namespace]
    target_label: namespace
  - source_labels: [__meta_kubernetes_pod_name]
    target_label: pod
```

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–µ–π–±–ª–æ–≤ –∏–∑ Kubernetes-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–µ—Ä–∞—Ä—Ö–∏–∏: cluster ‚Üí namespace ‚Üí pod ‚Üí container
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ª–µ–π–±–ª–æ–≤ –∏–∑ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π –ø–æ–¥–æ–≤

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç 2: Grafana Loki

### –ó–∞—á–µ–º –Ω—É–∂–µ–Ω —ç—Ç–æ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

Grafana Loki ‚Äî —ç—Ç–æ **–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤**, –∫–æ—Ç–æ—Ä–∞—è:

- üíæ –•—Ä–∞–Ω–∏—Ç –ª–æ–≥–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ (–±–µ–∑ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞)
- ‚ö° –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø–æ –ª–µ–π–±–ª–∞–º –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º
- üë• –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ OrgID
- üîÑ –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ (Grafana, Prometheus alerts)
- üìà –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –¥–ª—è –∑–∞–ø–∏—Å–∏ –∏ —á—Ç–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—à–∞–µ—Ç:**

- –í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ –≤ Elasticsearch
- –°–ª–æ–∂–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Elasticsearch-–∫–ª–∞—Å—Ç–µ—Ä–æ–º
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –≤ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ –∏–∑-–∑–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

#### 1. Multi-–∫–ª–∞—Å—Ç–µ—Ä–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

```yaml
targetCustomizations:
  - name: aggregator
    clusterSelector:
      matchLabels:
        okbtsp.corp/monitoring-aggregator: "true"
    helm:
      chart: loki-simple-scalable
  - name: namespace-only-placeholder
    clusterSelector:
      matchLabels:
        okbtsp.corp/department: OIT
```

- **–ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞** —Ç–æ–ª—å–∫–æ –≤ –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö
- **–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** (—Ç–æ–ª—å–∫–æ namespace) –≤–æ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–∞—Ö
- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏–∑ –≤—Å–µ—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤

#### 2. Enterprise-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ

```yaml
loki:
  storage:
    type: s3
    s3:
      endpoint: https://minio.okbtsp.corp
      bucketNames:
        chunks: loki-storage
        ruler: loki-storage
        admin: loki-storage
```

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ MinIO –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ chunks, ruler –∏ admin
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ retention policy

#### 3. –ú—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ OrgID

```python
# Python proxy –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è X-Scope-OrgID
token = auth[7:].strip()
org_id = TOKEN_TO_ORG.get(token)
req_headers['X-Scope-OrgID'] = org_id
```

- –ö–∞–∂–¥–∞—è –∫–æ–º–∞–Ω–¥–∞ –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
- –¢–æ–∫–µ–Ω—ã –º–∞–ø–ø—è—Ç—Å—è –Ω–∞ OrgID —á–µ—Ä–µ–∑ —Å–µ–∫—Ä–µ—Ç –≤ Bitwarden
- –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏
- –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –¥–æ—Å—Ç—É–ø–∞ —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π

#### 4. –û—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å

```yaml
write:
  replicas: 3
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 50
          preference:
            matchExpressions:
              - key: node-role.kubernetes.io/infra
                operator: In
                values: [""]
  tolerations:
    - key: "node-role.kubernetes.io/infra"
      effect: "NoSchedule"
```

- 3 —Ä–µ–ø–ª–∏–∫–∏ –¥–ª—è write –∏ read –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- 2 —Ä–µ–ø–ª–∏–∫–∏ –¥–ª—è gateway –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- –†–∞–∑–º–µ—â–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö infra-–Ω–æ–¥–∞—Ö
- Anti-affinity –¥–ª—è —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —Ä–∞–∑–Ω—ã–º —Ö–æ—Å—Ç–∞–º

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π

### 1. –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Cilium Gateway API

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: loki-route
spec:
  parentRefs:
    - name: shared-gateway
      namespace: cilium-gateway
      sectionName: https-corp
  hostnames:
    - "loki.okbtsp.corp"
```

- –ï–¥–∏–Ω—ã–π endpoint `loki.okbtsp.corp` –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- TLS termination –Ω–∞ —É—Ä–æ–≤–Ω–µ —à–ª—é–∑–∞
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å enterprise-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏

### 2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –í—Å–µ —Å–µ–∫—Ä–µ—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Bitwarden —á–µ—Ä–µ–∑ External Secrets Operator
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Pod Security Admission —Å —É—Ä–æ–≤–Ω–µ–º privileged
- –°–µ—Ç–µ–≤–∞—è –∏–∑–æ–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ NetworkPolicy (–Ω–µ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
- –†–µ–≥—É–ª—è—Ä–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –¥–æ—Å—Ç—É–ø–∞

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π self-monitoring —á–µ—Ä–µ–∑ Grafana Agent
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus –¥–ª—è —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫
- –ê–ª–µ—Ä—Ç—ã –Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –∑–∞–ø–∏—Å–∏ –∏ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–≤–æ—Ç –ø–æ OrgID

## –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

### GitOps-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è

```yaml
paths:
  - promtail
  - loki
```

- –ï–¥–∏–Ω—ã–π Git-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è –≤—Å–µ—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
- –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ dev –∏ master –≤–µ—Ç–∫–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
- –ö–æ–Ω—Ç—Ä–æ–ª—å –¥—Ä–µ–π—Ñ–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`correctDrift: enabled`)

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ dev-—Å—Ä–µ–¥–µ**:
   ```yaml
   branch: dev
   targets:
     - name: management
   ```
2. **–ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ prod**:
   ```yaml
   branch: master
   targets:
     - name: prod
   ```
3. **–û—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö**:
   - Fleet –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–µ—Ä–Ω–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `forceSyncGeneration` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

## Production-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–†–∞–∑–º–µ—Ä—ã PVC**:

   - –î–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ > 100 –Ω–æ–¥ —É–≤–µ–ª–∏—á—å—Ç–µ —Ä–∞–∑–º–µ—Ä –¥–æ 100-500Gi
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∏—Å–∫–∏ (vSAN)

2. **Retention Policy**:

   ```yaml
   compactor:
     compaction:
       retention_enabled: true
       delete_request_store: aws
   ```

   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –†–∞–∑–Ω—ã–µ –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ª–æ–≥–æ–≤ (debug vs production)

3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**:

   - –î–ª—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ > 500 –Ω–æ–¥ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ write/read path –Ω–∞ —Ä–∞–∑–Ω—ã–µ –ø—É–ª—ã
   - –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–ø–∞–∫—Ç–æ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ tenant'–∞

> **–í–∞–∂–Ω–æ:** –î–ª—è production-—Å—Ä–µ–¥ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç–∏–Ω–≥ –Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –∑–∞–ø–∏—Å–∏ –ª–æ–≥–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–≤–æ—Ç. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–≤–æ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ OrgID –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è DoS-–∞—Ç–∞–∫ –Ω–∞ —Å–∏—Å—Ç–µ–º—É. –†–µ–≥—É–ª—è—Ä–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ retention policy –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –ª–æ–≥–æ–≤.
